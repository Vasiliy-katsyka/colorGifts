<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gift Model Gallery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #181a1b;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
            --tg-theme-link-color: #8774e1;
            --tg-theme-button-color: #5288c1;
            --tg-theme-button-text-color: #ffffff;
            --glass-bg: rgba(40, 42, 44, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0; padding: 15px; color: var(--tg-theme-text-color);
            background-color: var(--tg-theme-bg-color); overscroll-behavior: none;
        }
        .filters-container { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-btn {
            padding: 10px 18px; border-radius: 12px; background: var(--glass-bg);
            border: 1px solid var(--border-color); color: var(--tg-theme-text-color);
            font-size: 14px; cursor: pointer; backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); transition: background-color 0.2s;
            flex-grow: 1; text-align: center;
        }
        .filter-btn:disabled { cursor: not-allowed; opacity: 0.5; }
        .filter-btn.active {
            background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }
        .model-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .model-card {
            background: var(--glass-bg); border: 1px solid var(--border-color);
            border-radius: 16px; overflow: hidden; backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .model-image-container {
            width: 100%; aspect-ratio: 1 / 1;
            display: flex; justify-content: center; align-items: center;
            background: transparent; transition: background 0.3s ease;
        }
        .model-image-container img {
            width: 75%; height: 75%; object-fit: contain; display: block;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.4));
        }
        .model-info { padding: 12px; }
        .model-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .collection-name { font-size: 12px; color: var(--tg-theme-hint-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: flex-end; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: #1c1e21; width: 100%; max-height: 80vh; border-radius: 20px 20px 0 0; padding: 15px; box-sizing: border-box; transform: translateY(100%); transition: transform 0.3s ease-out; }
        .modal-overlay.visible .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; font-size: 20px; }
        .close-btn, .clear-btn { background: none; border: none; font-size: 16px; color: var(--tg-theme-link-color); cursor: pointer; }
        .modal-search { width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: var(--tg-theme-text-color); border-radius: 10px; }
        .modal-list { max-height: calc(80vh - 150px); overflow-y: auto; }
        .modal-item { display: flex; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; gap: 15px; }
        .modal-item.selected { background: rgba(82, 136, 193, 0.2); }
        .modal-item img { width: 40px; height: 40px; border-radius: 8px; }
        /* New styles for color swatches */
        .color-swatch, .backdrop-preview {
            width: 28px; height: 28px;
            border-radius: 50%; /* Make it a circle */
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .message-container { text-align: center; padding: 50px; font-size: 18px; color: var(--tg-theme-hint-color); }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="filters-container">
            <button id="color-filter-btn" class="filter-btn" disabled>Color</button>
            <button id="backdrop-filter-btn" class="filter-btn" disabled>Backdrop</button>
            <button id="collection-filter-btn" class="filter-btn" disabled>Collection</button>
        </div>
        <div id="model-grid" class="model-grid"></div>
        <div id="message-container" class="message-container">Loading all gift data...</div>
    </div>
    
    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="modal-title">Filter</h2> <div> <button id="modal-clear-btn" class="clear-btn">Clear all</button> <button id="modal-close-btn" class="close-btn">Close</button> </div> </div>
            <input type="text" id="modal-search" class="modal-search" placeholder="Search...">
            <div id="modal-list" class="modal-list"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        const appData = {
            collections: [],
            backdrops: [],
            // --- CHANGE 1: New color list with RGB values ---
            colors: [
                { name: "black", rgb: [0, 0, 0] },
                { name: "gray", rgb: [128, 128, 128] },
                { name: "silver", rgb: [192, 192, 192] },
                { name: "white", rgb: [255, 255, 255] },
                { name: "red", rgb: [255, 0, 0] },
                { name: "brown", rgb: [139, 69, 19] },
                { name: "orange", rgb: [255, 165, 0] },
                { name: "gold", rgb: [255, 215, 0] },
                { name: "yellow", rgb: [255, 255, 0] },
                { name: "green", rgb: [0, 128, 0] },
                { name: "cyan", rgb: [0, 255, 255] },
                { name: "blue", rgb: [0, 0, 255] },
                { name: "purple", rgb: [128, 0, 128] },
                { name: "pink", rgb: [255, 192, 203] },
                { name: "unknown", rgb: [50, 50, 50] } // Added unknown for completeness
            ],
            colorModelMap: {}
        };

        const state = {
            currentFilters: { color: null, backdrop: null, collections: new Set() },
        };

        const elements = {
            grid: document.getElementById('model-grid'),
            message: document.getElementById('message-container'),
            colorBtn: document.getElementById('color-filter-btn'),
            backdropBtn: document.getElementById('backdrop-filter-btn'),
            collectionBtn: document.getElementById('collection-filter-btn'),
            modal: document.getElementById('filter-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalList: document.getElementById('modal-list'),
            modalSearch: document.getElementById('modal-search'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalClearBtn: document.getElementById('modal-clear-btn'),
        };

        let currentModalFilterType = null;

        const createModelCard = (model) => {
            const card = document.createElement('div');
            card.className = 'model-card';
            const backdropStyle = state.currentFilters.backdrop ? `radial-gradient(circle, ${state.currentFilters.backdrop.hex.centerColor}, ${state.currentFilters.backdrop.hex.edgeColor})` : 'transparent';
            card.innerHTML = `
                <div class="model-image-container" style="background: ${backdropStyle};">
                    <img src="${model.imageUrl}" alt="${model.model}" loading="lazy" onerror="this.style.display='none'">
                </div>
                <div class="model-info"> <div class="model-name">${model.model}</div> <div class="collection-name">${model.collection}</div> </div>
            `;
            return card;
        };

        const filterAndRenderModels = () => {
            elements.grid.innerHTML = '';
            if (!state.currentFilters.color) {
                elements.message.textContent = 'Select a color to begin...';
                elements.message.style.display = 'block';
                return;
            }

            const modelsForColor = appData.colorModelMap[state.currentFilters.color.name] || [];
            const selectedCollections = state.currentFilters.collections;
            
            const filteredModels = selectedCollections.size > 0
                ? modelsForColor.filter(([collectionName, modelName]) => selectedCollections.has(collectionName))
                : modelsForColor;

            if (filteredModels.length === 0) {
                elements.message.textContent = 'No models found for these filters.';
                elements.message.style.display = 'block';
            } else {
                elements.message.style.display = 'none';
                filteredModels.forEach(([collectionName, modelName]) => {
                    const encodedCollection = encodeURIComponent(collectionName);
                    const encodedModel = encodeURIComponent(modelName);
                    
                    // --- CHANGE 2: Updated model image URL format ---
                    const modelData = {
                        collection: collectionName,
                        model: modelName,
                        imageUrl: `https://cdn.changes.tg/gifts/models/${encodedCollection}/png/${encodedModel}.png`
                    };
                    elements.grid.appendChild(createModelCard(modelData));
                });
            }
        };

        const fetchAllData = async () => {
            try {
                const [collectionsRes, backdropsRes] = await Promise.all([
                    fetch("https://cdn.changes.tg/gifts/id-to-name.json"),
                    fetch("https://cdn.changes.tg/gifts/backdrops.json")
                ]);
                const collectionsJson = await collectionsRes.json();
                appData.collections = Object.entries(collectionsJson).map(([id, name]) => ({ id, name }));
                appData.backdrops = await backdropsRes.json();

                const repoApiUrl = "https://api.github.com/repos/Vasiliy-katsyka/colorGifts/contents/";
                const filesRes = await fetch(repoApiUrl);
                const files = await filesRes.json();

                const fileFetchPromises = files
                    .filter(file => file.name && file.name.endsWith('.json'))
                    .map(file => fetch(file.download_url).then(res => res.json().then(data => ({ name: file.name, data }))));

                const allColorData = await Promise.all(fileFetchPromises);

                allColorData.forEach(({ name, data }) => {
                    const giftName = name.replace('.json', '');
                    for (const [modelName, modelData] of Object.entries(data)) {
                        let mainColor = "unknown";
                        if (typeof modelData === 'object' && modelData !== null) mainColor = modelData.main_color || "unknown";
                        else if (typeof modelData === 'string') mainColor = modelData;
                        
                        if (!appData.colorModelMap[mainColor]) appData.colorModelMap[mainColor] = [];
                        appData.colorModelMap[mainColor].push([giftName, modelName]);
                    }
                });
                
                elements.message.textContent = 'Select a color to begin...';
                elements.colorBtn.disabled = false;
                elements.backdropBtn.disabled = false;
                elements.collectionBtn.disabled = false;

            } catch (error) {
                console.error("Failed to load initial app data:", error);
                elements.message.textContent = 'Error: Could not load gift data. Please refresh.';
            }
        };
        
        const openModal = (filterType) => {
            currentModalFilterType = filterType;
            elements.modalTitle.textContent = `Select ${filterType}`;
            populateModalList();
            elements.modal.classList.add('visible');
        };
        const closeModal = () => elements.modal.classList.remove('visible');

        const populateModalList = (searchTerm = '') => {
            elements.modalList.innerHTML = '';
            let items = appData[currentModalFilterType + 's'] || [];
            if (searchTerm) items = items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));

            items.forEach(item => {
                const li = document.createElement('div');
                li.className = 'modal-item';
                let isSelected = false;

                // --- CHANGE 3: Logic to display color swatch ---
                if (currentModalFilterType === 'color') {
                    isSelected = state.currentFilters.color?.name === item.name;
                    const [r, g, b] = item.rgb;
                    li.innerHTML = `<div class="color-swatch" style="background-color: rgb(${r}, ${g}, ${b});"></div><span>${item.name.charAt(0).toUpperCase() + item.name.slice(1)}</span>`;
                } else if (currentModalFilterType === 'backdrop') {
                    isSelected = state.currentFilters.backdrop?.name === item.name;
                    const gradient = `radial-gradient(circle, ${item.hex.centerColor}, ${item.hex.edgeColor})`;
                    li.innerHTML = `<div class="backdrop-preview" style="background: ${gradient}; border-radius: 8px;"></div><span>${item.name}</span>`;
                } else { // collection
                    isSelected = state.currentFilters.collections.has(item.name);
                    li.innerHTML = `<img src="https://cdn.changes.tg/gifts/originals/${item.id}/Original.png" alt=""><span>${item.name}</span>`;
                }

                if (isSelected) li.classList.add('selected');
                li.addEventListener('click', () => handleModalItemClick(item));
                elements.modalList.appendChild(li);
            });
        };

        const handleModalItemClick = (item) => {
            if (currentModalFilterType === 'color' || currentModalFilterType === 'backdrop') {
                state.currentFilters[currentModalFilterType] = state.currentFilters[currentModalFilterType]?.name === item.name ? null : item;
            } else { // collection
                const set = state.currentFilters.collections;
                set.has(item.name) ? set.delete(item.name) : set.add(item.name);
            }
            updateFilterButtons();
            populateModalList(elements.modalSearch.value);
            closeModal();
            filterAndRenderModels();
        };
        
        const updateFilterButtons = () => {
            elements.colorBtn.textContent = state.currentFilters.color ? state.currentFilters.color.name : 'Color';
            elements.colorBtn.classList.toggle('active', !!state.currentFilters.color);
            elements.backdropBtn.textContent = state.currentFilters.backdrop ? state.currentFilters.backdrop.name : 'Backdrop';
            elements.backdropBtn.classList.toggle('active', !!state.currentFilters.backdrop);
            const collCount = state.currentFilters.collections.size;
            elements.collectionBtn.textContent = collCount > 0 ? `Collection (${collCount})` : 'Collection';
            elements.collectionBtn.classList.toggle('active', collCount > 0);
        };
        
        const clearModalFilter = () => {
            if (currentModalFilterType === 'collection') state.currentFilters.collections.clear();
            else state.currentFilters[currentModalFilterType] = null;
            updateFilterButtons();
            populateModalList();
        };

        elements.colorBtn.addEventListener('click', () => openModal('color'));
        elements.backdropBtn.addEventListener('click', () => openModal('backdrop'));
        elements.collectionBtn.addEventListener('click', () => openModal('collection'));
        elements.modalCloseBtn.addEventListener('click', closeModal);
        elements.modal.addEventListener('click', (e) => { if (e.target === elements.modal) closeModal(); });
        elements.modalClearBtn.addEventListener('click', () => { clearModalFilter(); closeModal(); filterAndRenderModels(); });
        elements.modalSearch.addEventListener('input', (e) => populateModalList(e.target.value));

        fetchAllData();
    });
    </script>
</body>
</html>