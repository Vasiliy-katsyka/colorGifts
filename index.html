<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Gift Model Gallery</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #181a1b;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #aaaaaa;
            --tg-theme-link-color: #8774e1;
            --tg-theme-button-color: #5288c1;
            --tg-theme-button-text-color: #ffffff;
            --glass-bg: rgba(40, 42, 44, 0.6);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 15px;
            color: var(--tg-theme-text-color);
            background-color: var(--tg-theme-bg-color);
            overscroll-behavior: none;
        }

        /* --- Filters --- */
        .filters-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .filter-btn {
            padding: 10px 18px;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            color: var(--tg-theme-text-color);
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.2s;
            flex-grow: 1;
        }
        .filter-btn:hover { background: rgba(50, 52, 54, 0.8); }
        .filter-btn.active {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        /* --- Model Grid --- */
        .model-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .model-card {
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .model-card img {
            width: 100%;
            aspect-ratio: 1 / 1;
            background-color: rgba(0,0,0,0.2);
            display: block;
        }
        .model-info { padding: 12px; }
        .model-name {
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .collection-name {
            font-size: 12px;
            color: var(--tg-theme-hint-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- Modal (same as before, but simplified) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex; align-items: flex-end;
            justify-content: center; opacity: 0; visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s; z-index: 1000;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #1c1e21; width: 100%; max-height: 80vh;
            border-radius: 20px 20px 0 0; padding: 15px; box-sizing: border-box;
            transform: translateY(100%); transition: transform 0.3s ease-out;
        }
        .modal-overlay.visible .modal-content { transform: translateY(0); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; font-size: 20px; }
        .close-btn, .clear-btn { background: none; border: none; font-size: 16px; color: var(--tg-theme-link-color); cursor: pointer; }
        .modal-search { width: 100%; padding: 10px; box-sizing: border-box; margin-bottom: 15px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); color: var(--tg-theme-text-color); border-radius: 10px; }
        .modal-list { max-height: calc(80vh - 150px); overflow-y: auto; }
        .modal-item { display: flex; align-items: center; padding: 10px; border-radius: 10px; cursor: pointer; gap: 15px; }
        .modal-item.selected { background: rgba(82, 136, 193, 0.2); }
        .modal-item img { width: 40px; height: 40px; border-radius: 8px; }
        
        /* --- Loader / Message --- */
        .message-container { text-align: center; padding: 50px; font-size: 18px; color: var(--tg-theme-hint-color); }
    </style>
</head>
<body>

    <div class="app-container">
        <div class="filters-container">
            <button id="color-filter-btn" class="filter-btn">Color</button>
            <button id="collection-filter-btn" class="filter-btn">Collection (Optional)</button>
        </div>

        <div id="model-grid" class="model-grid"></div>
        <div id="message-container" class="message-container">Select a color to begin...</div>
    </div>
    
    <!-- Filter Modal -->
    <div id="filter-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Filter</h2>
                <div>
                    <button id="modal-clear-btn" class="clear-btn">Clear all</button>
                    <button id="modal-close-btn" class="close-btn">Close</button>
                </div>
            </div>
            <input type="text" id="modal-search" class="modal-search" placeholder="Search...">
            <div id="modal-list" class="modal-list"></div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const API_BASE_URL = 'https://your-render-app-name.onrender.com/api'; // IMPORTANT: Change this

        let state = {
            allFiltersData: {},
            currentFilters: { color: null, collections: new Set() },
        };

        const elements = {
            grid: document.getElementById('model-grid'),
            message: document.getElementById('message-container'),
            colorBtn: document.getElementById('color-filter-btn'),
            collectionBtn: document.getElementById('collection-filter-btn'),
            modal: document.getElementById('filter-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalList: document.getElementById('modal-list'),
            modalSearch: document.getElementById('modal-search'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalClearBtn: document.getElementById('modal-clear-btn'),
        };

        let currentModalFilterType = null;

        const createModelCard = (model) => {
            const card = document.createElement('div');
            card.className = 'model-card';
            card.innerHTML = `
                <img src="${model.imageUrl}" alt="${model.model}" loading="lazy" onerror="this.style.display='none'">
                <div class="model-info">
                    <div class="model-name">${model.model}</div>
                    <div class="collection-name">${model.collection}</div>
                </div>
            `;
            return card;
        };

        const renderModels = (models) => {
            elements.grid.innerHTML = '';
            if (models.length === 0) {
                elements.message.textContent = 'No models found for these filters.';
                elements.message.style.display = 'block';
            } else {
                elements.message.style.display = 'none';
                models.forEach(model => elements.grid.appendChild(createModelCard(model)));
            }
        };

        const fetchAllFilters = async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/filters`);
                state.allFiltersData = await response.json();
            } catch (error) {
                console.error("Failed to fetch filters:", error);
                elements.message.textContent = 'Error loading filters. Please try again later.';
            }
        };

        const fetchModels = async () => {
            if (!state.currentFilters.color) {
                elements.grid.innerHTML = '';
                elements.message.textContent = 'Select a color to begin...';
                elements.message.style.display = 'block';
                return;
            }

            elements.message.textContent = 'Loading...';
            elements.message.style.display = 'block';
            elements.grid.innerHTML = '';

            const params = new URLSearchParams({ color: state.currentFilters.color });
            if (state.currentFilters.collections.size > 0) {
                params.append('collections', Array.from(state.currentFilters.collections).join(','));
            }

            try {
                const response = await fetch(`${API_BASE_URL}/models?${params.toString()}`);
                const models = await response.json();
                renderModels(models);
            } catch (error) {
                console.error("Failed to fetch models:", error);
                elements.message.textContent = 'Failed to load models. Please check your connection.';
            }
        };

        const openModal = (filterType) => {
            currentModalFilterType = filterType;
            elements.modalTitle.textContent = `Select ${filterType}`;
            populateModalList();
            elements.modal.classList.add('visible');
        };

        const closeModal = () => {
            elements.modal.classList.remove('visible');
        };

        const populateModalList = (searchTerm = '') => {
            elements.modalList.innerHTML = '';
            let items = (currentModalFilterType === 'color') ? state.allFiltersData.colors : state.allFiltersData.collections;
            items = items || [];

            if (searchTerm) {
                items = items.filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()));
            }

            items.forEach(item => {
                const li = document.createElement('div');
                li.className = 'modal-item';
                li.dataset.value = item.name;
                
                let isSelected = false;
                if (currentModalFilterType === 'color') {
                    isSelected = state.currentFilters.color === item.name;
                    li.innerHTML = `<span>${item.name.charAt(0).toUpperCase() + item.name.slice(1)}</span>`;
                } else { // collection
                    isSelected = state.currentFilters.collections.has(item.name);
                    li.innerHTML = `<img src="https://cdn.changes.tg/gifts/originals/${item.id}/Original.png" alt=""><span>${item.name}</span>`;
                }

                if (isSelected) li.classList.add('selected');
                
                li.addEventListener('click', () => handleModalItemClick(item.name));
                elements.modalList.appendChild(li);
            });
        };

        const handleModalItemClick = (value) => {
            if (currentModalFilterType === 'color') {
                state.currentFilters.color = state.currentFilters.color === value ? null : value;
            } else {
                const set = state.currentFilters.collections;
                set.has(value) ? set.delete(value) : set.add(value);
            }
            updateFilterButtons();
            populateModalList(elements.modalSearch.value);
            if (currentModalFilterType === 'color') {
                 closeModal();
                 fetchModels();
            }
        };

        const updateFilterButtons = () => {
            elements.colorBtn.textContent = state.currentFilters.color ? `Color: ${state.currentFilters.color}` : 'Color';
            elements.colorBtn.classList.toggle('active', !!state.currentFilters.color);
            
            const collCount = state.currentFilters.collections.size;
            elements.collectionBtn.textContent = collCount > 0 ? `Collection (${collCount})` : 'Collection (Optional)';
            elements.collectionBtn.classList.toggle('active', collCount > 0);
        };
        
        elements.colorBtn.addEventListener('click', () => openModal('color'));
        elements.collectionBtn.addEventListener('click', () => openModal('collection'));
        
        elements.modalCloseBtn.addEventListener('click', () => { closeModal(); fetchModels(); });
        elements.modal.addEventListener('click', (e) => { if (e.target === elements.modal) { closeModal(); fetchModels(); } });
        elements.modalClearBtn.addEventListener('click', () => {
            if (currentModalFilterType === 'color') state.currentFilters.color = null;
            else if (currentModalFilterType === 'collection') state.currentFilters.collections.clear();
            updateFilterButtons();
            populateModalList();
        });
        elements.modalSearch.addEventListener('input', (e) => populateModalList(e.target.value));

        fetchAllFilters();
    });
    </script>
</body>
</html>
